{% extends "base.html" %}
{% block title %}{{ manifest.display_name }} â€” Hassette{% endblock %}

{% block content %}
<!-- Header -->
<div class="level mb-4">
  <div class="level-left">
    <div class="level-item">
      <h1 class="title is-4">
        <a href="/ui/apps" class="has-text-grey-light mr-2"><i class="fas fa-arrow-left"></i></a>
        <span class="icon"><i class="fas fa-cube"></i></span>
        <span>{{ manifest.display_name }}</span>
        {% if manifest.status == "running" %}
        <span class="tag is-success is-light ml-2">running</span>
        {% elif manifest.status == "failed" %}
        <span class="tag is-danger is-light ml-2">failed</span>
        {% elif manifest.status == "stopped" %}
        <span class="tag ht-status-stopped ml-2">stopped</span>
        {% elif manifest.status == "disabled" %}
        <span class="tag ht-status-disabled ml-2">disabled</span>
        {% elif manifest.status == "blocked" %}
        <span class="tag ht-status-blocked ml-2">blocked</span>
        {% endif %}
      </h1>
    </div>
  </div>
  <div class="level-right">
    <div class="level-item">
      <div class="buttons are-small">
        {% if manifest.status == "running" %}
        <button class="button is-warning is-outlined"
                hx-post="/api/apps/{{ app_key }}/stop"
                hx-swap="none"
                hx-on::after-request="location.reload()">
          <span class="icon"><i class="fas fa-stop"></i></span>
          <span>Stop</span>
        </button>
        <button class="button is-info is-outlined"
                hx-post="/api/apps/{{ app_key }}/reload"
                hx-swap="none"
                hx-on::after-request="location.reload()">
          <span class="icon"><i class="fas fa-rotate"></i></span>
          <span>Reload</span>
        </button>
        {% elif manifest.status in ["failed", "stopped"] %}
        <button class="button is-success is-outlined"
                hx-post="/api/apps/{{ app_key }}/start"
                hx-swap="none"
                hx-on::after-request="location.reload()">
          <span class="icon"><i class="fas fa-play"></i></span>
          <span>Start</span>
        </button>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<div class="columns is-multiline">
  <!-- Config panel -->
  <div class="column is-half">
    <div class="box">
      <h2 class="title is-5">Configuration</h2>
      <table class="table is-fullwidth is-compact">
        <tbody>
          <tr><th>App Key</th><td><code>{{ manifest.app_key }}</code></td></tr>
          <tr><th>Class Name</th><td><code>{{ manifest.class_name }}</code></td></tr>
          <tr><th>Filename</th><td><code>{{ manifest.filename }}</code></td></tr>
          <tr><th>Enabled</th><td>{{ "Yes" if manifest.enabled else "No" }}</td></tr>
          <tr><th>Auto-loaded</th><td>{{ "Yes" if manifest.auto_loaded else "No" }}</td></tr>
          <tr><th>Instances</th><td>{{ manifest.instance_count }}</td></tr>
          {% if manifest.error_message %}
          <tr><th>Error</th><td class="has-text-danger">{{ manifest.error_message }}</td></tr>
          {% endif %}
          {% if manifest.block_reason %}
          <tr><th>Block Reason</th><td>{{ manifest.block_reason }}</td></tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Bus Listeners -->
  <div class="column is-half">
    <div class="box">
      <h2 class="title is-5">
        <span class="icon"><i class="fas fa-ear-listen"></i></span>
        <span>Bus Listeners</span>
      </h2>
      <div id="app-listeners"
           data-live-on-app="/ui/partials/app-detail-listeners/{{ app_key }}"
           hx-get="/ui/partials/app-detail-listeners/{{ app_key }}"
           hx-trigger="every 30s"
           hx-swap="innerHTML">
        {% include "partials/app_detail_listeners.html" %}
      </div>
    </div>
  </div>

  <!-- Scheduled Jobs -->
  <div class="column is-half">
    <div class="box">
      <h2 class="title is-5">
        <span class="icon"><i class="fas fa-clock"></i></span>
        <span>Scheduled Jobs</span>
      </h2>
      <div id="app-jobs"
           data-live-refresh="/ui/partials/app-detail-jobs/{{ app_key }}"
           hx-get="/ui/partials/app-detail-jobs/{{ app_key }}"
           hx-trigger="every 30s"
           hx-swap="innerHTML">
        {% include "partials/app_detail_jobs.html" %}
      </div>
    </div>
  </div>

  <!-- Recent Logs -->
  <div class="column is-half">
    <div class="box">
      <h2 class="title is-5">
        <span class="icon"><i class="fas fa-scroll"></i></span>
        <span>Recent Logs</span>
      </h2>
      <div class="ht-log-container" style="max-height: 400px; overflow-y: auto;">
        <table class="table is-fullwidth is-hoverable is-compact is-size-7">
          <thead>
            <tr>
              <th style="width: 80px;">Level</th>
              <th style="width: 160px;">Timestamp</th>
              <th>Message</th>
            </tr>
          </thead>
          <tbody id="app-log-entries"
                 hx-get="/ui/partials/log-entries?app_key={{ app_key }}&limit=50"
                 hx-trigger="every 30s"
                 hx-swap="innerHTML">
            {% include "partials/log_entries.html" %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
{% endblock %}
