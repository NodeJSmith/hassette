{% extends "base.html" %}
{% block title %}Logs â€” Hassette{% endblock %}

{% block content %}
<h1 class="title is-4">
  <span class="icon"><i class="fas fa-scroll"></i></span>
  <span>Log Viewer</span>
</h1>

<div class="box" x-data="logTable({ showAppColumn: true, appKey: null })">
  <!-- Filter controls -->
  <div class="field is-grouped mb-4">
    <div class="control">
      <div class="select is-small">
        <select x-model="filters.level">
          <option value="">All Levels</option>
          <option value="DEBUG">DEBUG</option>
          <option value="INFO">INFO</option>
          <option value="WARNING">WARNING</option>
          <option value="ERROR">ERROR</option>
          <option value="CRITICAL">CRITICAL</option>
        </select>
      </div>
    </div>
    <div class="control">
      <div class="select is-small">
        <select x-model="filters.app">
          <option value="">All Apps</option>
          {% for key in app_keys %}
          <option value="{{ key }}">{{ key }}</option>
          {% endfor %}
        </select>
      </div>
    </div>
    <div class="control">
      <input class="input is-small" type="text" placeholder="Search..."
             x-model.debounce.200ms="filters.search">
    </div>
    <div class="control">
      <span class="tag is-light is-small" x-show="!loading"
            x-text="filteredEntries.length + ' entries'"></span>
      <span class="tag is-light is-small" x-show="loading">Loading...</span>
    </div>
  </div>

  <!-- Log entries -->
  <div class="ht-log-container" style="max-height: 600px; overflow-y: auto;">
    <table class="table is-fullwidth is-hoverable is-compact is-size-7">
      <thead>
        <tr>
          <th style="width: 80px; cursor: pointer;" @click="toggleSort('level')">
            Level <i class="fas" :class="sortIcon('level')"></i>
          </th>
          <th style="width: 160px; cursor: pointer;" @click="toggleSort('timestamp')">
            Timestamp <i class="fas" :class="sortIcon('timestamp')"></i>
          </th>
          <th style="width: 120px; cursor: pointer;" @click="toggleSort('app_key')">
            App <i class="fas" :class="sortIcon('app_key')"></i>
          </th>
          <th style="cursor: pointer;" @click="toggleSort('message')">
            Message <i class="fas" :class="sortIcon('message')"></i>
          </th>
        </tr>
      </thead>
      <tbody>
        <template x-if="loading">
          <tr><td colspan="4" class="has-text-centered has-text-grey">Loading...</td></tr>
        </template>
        <template x-if="error">
          <tr><td colspan="4" class="has-text-centered has-text-danger" x-text="error"></td></tr>
        </template>
        <template x-if="!loading && !error && filteredEntries.length === 0">
          <tr><td colspan="4" class="has-text-centered has-text-grey">No log entries.</td></tr>
        </template>
        <template x-for="(entry, index) in filteredEntries" :key="entry.timestamp + '-' + index">
          <tr>
            <td>
              <span class="tag is-small" :class="levelClass(entry.level)"
                    x-text="entry.level"></span>
            </td>
            <td x-text="formatTime(entry.timestamp)"></td>
            <td>
              <template x-if="entry.app_key">
                <a :href="'/ui/apps/' + encodeURIComponent(entry.app_key)"><code x-text="entry.app_key"></code></a>
              </template>
              <template x-if="!entry.app_key">
                <code>&mdash;</code>
              </template>
            </td>
            <td x-text="entry.message"></td>
          </tr>
        </template>
      </tbody>
    </table>
  </div>
</div>
{% endblock %}
