{% extends "base.html" %}
{% block title %}{{ instance.instance_name if instance else manifest.display_name }} â€” Hassette{% endblock %}

{% block content %}
<!-- Header -->
<div class="level mb-4">
  <div class="level-left">
    <div class="level-item">
      <h1 class="title is-4">
        <a href="/ui/apps" class="has-text-grey-light mr-2"><i class="fas fa-arrow-left"></i></a>
        {% if is_multi_instance %}
        <a href="/ui/apps/{{ app_key }}" class="has-text-grey-light mr-2"><i class="fas fa-cubes"></i></a>
        {% endif %}
        <span class="icon"><i class="fas fa-cube"></i></span>
        <span>{{ manifest.display_name }}</span>
        {% set inst_status = instance.status if instance else manifest.status %}
        {% if inst_status == "running" %}
        <span class="tag is-success is-light ml-2">running</span>
        {% elif inst_status == "failed" %}
        <span class="tag is-danger is-light ml-2">failed</span>
        {% elif inst_status == "stopped" %}
        <span class="tag ht-status-stopped ml-2">stopped</span>
        {% elif inst_status == "disabled" %}
        <span class="tag ht-status-disabled ml-2">disabled</span>
        {% elif inst_status == "blocked" %}
        <span class="tag ht-status-blocked ml-2">blocked</span>
        {% endif %}
      </h1>
    </div>
  </div>
  <div class="level-right">
    <div class="level-item">
      <div class="buttons are-small">
        {% if manifest.status == "running" %}
        <button class="button is-warning is-outlined"
                hx-post="/api/apps/{{ app_key }}/stop"
                hx-swap="none"
                hx-on::after-request="location.reload()">
          <span class="icon"><i class="fas fa-stop"></i></span>
          <span>Stop</span>
        </button>
        <button class="button is-info is-outlined"
                hx-post="/api/apps/{{ app_key }}/reload"
                hx-swap="none"
                hx-on::after-request="location.reload()">
          <span class="icon"><i class="fas fa-rotate"></i></span>
          <span>Reload</span>
        </button>
        {% elif manifest.status in ["failed", "stopped"] %}
        <button class="button is-success is-outlined"
                hx-post="/api/apps/{{ app_key }}/start"
                hx-swap="none"
                hx-on::after-request="location.reload()">
          <span class="icon"><i class="fas fa-play"></i></span>
          <span>Start</span>
        </button>
        {% endif %}
      </div>
    </div>
  </div>
</div>

{% if is_multi_instance and instance %}
<p class="subtitle is-6 has-text-grey mb-4">
  Instance: <strong>{{ instance.instance_name }}</strong> (index {{ instance_index }})
</p>
{% endif %}

<div class="columns is-multiline">
  <!-- Config panel -->
  <div class="column is-half">
    <div class="box">
      <h2 class="title is-5">Configuration</h2>
      <table class="table is-fullwidth is-compact">
        <tbody>
          <tr><th>App Key</th><td><code>{{ manifest.app_key }}</code></td></tr>
          <tr><th>Class Name</th><td><code>{{ manifest.class_name }}</code></td></tr>
          {% if instance %}
          <tr><th>Instance Name</th><td><code>{{ instance.instance_name }}</code></td></tr>
          <tr><th>Index</th><td>{{ instance_index }}</td></tr>
          {% if owner_id %}
          <tr><th>Owner ID</th><td><code>{{ owner_id }}</code></td></tr>
          {% endif %}
          {% endif %}
          {% if is_multi_instance %}
          <tr><th>Manifest</th><td><a href="/ui/apps/{{ app_key }}"><code>{{ manifest.filename }}</code></a></td></tr>
          {% else %}
          <tr><th>Filename</th><td><code>{{ manifest.filename }}</code></td></tr>
          <tr><th>Enabled</th><td>{{ "Yes" if manifest.enabled else "No" }}</td></tr>
          <tr><th>Auto-loaded</th><td>{{ "Yes" if manifest.auto_loaded else "No" }}</td></tr>
          {% endif %}
          {% if instance and instance.error_message %}
          <tr><th>Error</th><td class="has-text-danger">{{ instance.error_message }}</td></tr>
          {% elif manifest.error_message %}
          <tr><th>Error</th><td class="has-text-danger">{{ manifest.error_message }}</td></tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Bus Listeners -->
  <div class="column is-half">
    <div class="box">
      <h2 class="title is-5">
        <span class="icon"><i class="fas fa-ear-listen"></i></span>
        <span>Bus Listeners</span>
      </h2>
      <div id="app-listeners"
           data-live-on-app="/ui/partials/instance-listeners/{{ app_key }}/{{ instance_index }}"
           hx-get="/ui/partials/instance-listeners/{{ app_key }}/{{ instance_index }}"
           hx-trigger="every 30s"
           hx-swap="innerHTML">
        {% include "partials/app_detail_listeners.html" %}
      </div>
    </div>
  </div>

  <!-- Scheduled Jobs -->
  <div class="column is-half">
    <div class="box">
      <h2 class="title is-5">
        <span class="icon"><i class="fas fa-clock"></i></span>
        <span>Scheduled Jobs</span>
      </h2>
      <div id="app-jobs"
           data-live-refresh="/ui/partials/instance-jobs/{{ app_key }}/{{ instance_index }}"
           hx-get="/ui/partials/instance-jobs/{{ app_key }}/{{ instance_index }}"
           hx-trigger="every 30s"
           hx-swap="innerHTML">
        {% include "partials/app_detail_jobs.html" %}
      </div>
    </div>
  </div>

  <!-- Recent Logs -->
  <div class="column is-half">
    <div class="box" x-data="logTable({ showAppColumn: false, appKey: '{{ app_key }}' })">
      <h2 class="title is-5">
        <span class="icon"><i class="fas fa-scroll"></i></span>
        <span>Recent Logs</span>
      </h2>
      <div class="field is-grouped mb-3">
        <div class="control">
          <div class="select is-small">
            <select x-model="filters.level">
              <option value="">All Levels</option>
              <option value="DEBUG">DEBUG</option>
              <option value="INFO">INFO</option>
              <option value="WARNING">WARNING</option>
              <option value="ERROR">ERROR</option>
              <option value="CRITICAL">CRITICAL</option>
            </select>
          </div>
        </div>
        <div class="control">
          <input class="input is-small" type="text" placeholder="Search..."
                 x-model.debounce.200ms="filters.search">
        </div>
        <div class="control">
          <span class="tag is-light is-small" x-show="!loading"
                x-text="filteredEntries.length + ' entries'"></span>
        </div>
      </div>
      <div class="ht-log-container" style="max-height: 400px; overflow-y: auto;">
        <table class="table is-fullwidth is-hoverable is-compact is-size-7">
          <thead>
            <tr>
              <th style="width: 80px; cursor: pointer;" @click="toggleSort('level')">
                Level <i class="fas" :class="sortIcon('level')"></i>
              </th>
              <th style="width: 160px; cursor: pointer;" @click="toggleSort('timestamp')">
                Timestamp <i class="fas" :class="sortIcon('timestamp')"></i>
              </th>
              <th style="cursor: pointer;" @click="toggleSort('message')">
                Message <i class="fas" :class="sortIcon('message')"></i>
              </th>
            </tr>
          </thead>
          <tbody>
            <template x-if="loading">
              <tr><td colspan="3" class="has-text-centered has-text-grey">Loading...</td></tr>
            </template>
            <template x-if="error">
              <tr><td colspan="3" class="has-text-centered has-text-danger" x-text="error"></td></tr>
            </template>
            <template x-if="!loading && !error && filteredEntries.length === 0">
              <tr><td colspan="3" class="has-text-centered has-text-grey">No log entries.</td></tr>
            </template>
            <template x-for="(entry, index) in filteredEntries" :key="entry.timestamp + '-' + index">
              <tr>
                <td>
                  <span class="tag is-small" :class="levelClass(entry.level)"
                        x-text="entry.level"></span>
                </td>
                <td x-text="formatTime(entry.timestamp)"></td>
                <td x-text="entry.message"></td>
              </tr>
            </template>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
{% endblock %}
